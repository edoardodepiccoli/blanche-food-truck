<style>
  h2 {
    position: relative;
    display: inline-block;
  }

  h2::before {
    background-color: #FFEB3B;
    content: "";
    position: absolute;
    width: 100%;
    height: 60%;
    left: 0;
    bottom: 0;
    z-index: -1;
    transform: rotate(-1deg);
  }
</style>

<div>
  <% if @today_stops.any? %>
    <div class="bg-gradient-to-br from-base-200 via-base-300 to-base-200 p-6 rounded-lg shadow-lg mb-8 relative overflow-hidden">
      <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_120%,rgba(255,255,255,0.1),rgba(255,255,255,0))]"></div>
      <div class="relative">
        <h2 class="text-2xl font-bold mb-4 relative inline-block">
          <span class="relative z-10">â­ Dove ci trovi oggi â­</span>
          <span class="absolute inset-0 bg-yellow-300/50 -rotate-1"></span>
        </h2>
      </div>
      <ul>
        <% @today_stops.each do |stop| %>
          <div class="collapse collapse-arrow bg-base-100 mb-2">
            <input type="checkbox" name="collapse" checked="checked" />
            <div class="collapse-title">
              <p class="text-lg"><span class="font-bold">ğŸ“Œ <%= stop.name %></span> - <span class="text-sm"><%= l(stop.start_datetime, format: "%A %d %B") %></span></p>
            </div>
            <div class="collapse-content">
              <p>Indirizzo esatto: <a href="<%= stop.google_maps_url %>" class="link link-hover text-blue-500" target="_blank"><%= stop.address %></a>. Dalle <%= l(stop.start_datetime, format: "%H:%M") %> alle <%= l(stop.end_datetime, format: "%H:%M") %></p>
              <div class="flex justify-center">
                <a href="<%= stop.whatsapp_group_url %>" class="btn text-white bg-[#25D366] mt-4 w-full" target="_blank">ğŸ’¬ Unisciti al gruppo WhatsApp</a>
              </div>
              <% if user_signed_in? %>
                <div class="flex justify-center gap-2 mt-2">
                  <a href="<%= edit_stop_path(stop) %>" data-turbo-method="get" class="btn btn-primary btn-outline flex-1">ğŸ”§ Modifica</a>
                  <a href="<%= stop_path(stop) %>" data-turbo-method="delete" class="btn btn-error btn-outline flex-1">ğŸ—‘ï¸ Elimina</a>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </ul>
    </div>
  <% end %>
</div>

<div class="py-4 border-b border-base-300 border-dashed pb-24" data-controller="map" 
     data-map-access-token-value="<%= ENV.fetch("MAPBOX_ACCESS_TOKEN") %>"
     data-map-today-stops-value="<%= @today_stops.to_json(methods: [:google_maps_url], only: [:latitude, :longitude, :name, :start_datetime]) %>"
     data-map-upcoming-stops-value="<%= @upcoming_stops.to_json(methods: [:google_maps_url], only: [:latitude, :longitude, :name, :start_datetime]) %>">
  <div class="shadow-xl" id="map" style="width: 100%; height: 400px;"></div>
</div>

<div class="py-4 border-b border-base-300 border-dashed pb-24">
  <% if @upcoming_stops.any? %>
    <h2 class="text-2xl font-bold mb-2 relative inline-block">
      <span class="relative z-10">Tappe future</span>
      <span class="absolute inset-0 bg-yellow-300/50 -rotate-1"></span>
    </h2>
    <ul>
      <% @upcoming_stops.each_with_index do |stop, index| %>
        <% next_stop = @upcoming_stops[index + 1] %>
        <% different_week = next_stop && stop.start_datetime.beginning_of_week != next_stop.start_datetime.beginning_of_week %>
        <% if index == 0 || (index > 0 && stop.start_datetime.beginning_of_week != @upcoming_stops[index - 1].start_datetime.beginning_of_week) %>
          <h3 class="text-xl font-semibold mb-4 mt-6">ğŸ“… Settimana del <%= l(stop.start_datetime.beginning_of_week, format: "%d/%m/%Y") %></h3>
        <% end %>
        <div class="shadow-lg collapse collapse-arrow bg-base-200 mb-2 <%= 'mb-8' if different_week %>">
          <input type="checkbox" name="collapse" />
          <div class="collapse-title">
            <p class="text-lg"><span class="font-bold">ğŸ“Œ <%= stop.name %></span> - <span class="text-sm"><%= l(stop.start_datetime, format: "%A %d %B") %></span></p>
          </div>
          <div class="collapse-content">
            <p>Indirizzo esatto: <a href="<%= stop.google_maps_url %>" class="link link-hover text-blue-500" target="_blank"><%= stop.address %></a>. Dalle <%= l(stop.start_datetime, format: "%H:%M") %> alle <%= l(stop.end_datetime, format: "%H:%M") %></p>
            <div class="flex justify-center">
              <a href="<%= stop.whatsapp_group_url %>" class="btn text-white bg-[#25D366] mt-4 w-full" target="_blank">ğŸ’¬ Unisciti al gruppo WhatsApp</a>
            </div>
            <% if user_signed_in? %>
              <div class="flex justify-center gap-2 mt-2">
                <a href="<%= edit_stop_path(stop) %>" data-turbo-method="get" class="btn btn-primary btn-outline flex-1">ğŸ”§ Modifica</a>
                <a href="<%= stop_path(stop) %>" data-turbo-method="delete" class="btn btn-error btn-outline flex-1">ğŸ—‘ï¸ Elimina</a>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </ul>
  <% end %> 
</div>

<div class="py-4 pb-32">
  <% if @past_stops.any? %>
    <h2 class="text-2xl font-bold mb-4 relative inline-block">
      <span class="relative z-10">Tappe passate</span>
      <span class="absolute inset-0 bg-yellow-300/50 -rotate-1"></span>
    </h2>
    <ul>
      <% @past_stops.each do |stop| %>
        <div class="collapse collapse-arrow bg-base-200 mb-2 opacity-50">
          <input type="checkbox" name="collapse" />
          <div class="collapse-title">
            <p class="text-lg"><span class="font-bold">ğŸ“Œ <%= stop.name %></span> - <span class="text-sm"><%= l(stop.start_datetime, format: "%A %d %B") %></span></p>
          </div>
          <div class="collapse-content">
            <p>Indirizzo esatto: <a href="<%= stop.google_maps_url %>" class="link link-hover text-blue-500" target="_blank"><%= stop.address %></a>. Dalle <%= l(stop.start_datetime, format: "%H:%M") %> alle <%= l(stop.end_datetime, format: "%H:%M") %></p>
            <div class="flex justify-center">
              <a href="<%= stop.whatsapp_group_url %>" class="btn text-white bg-[#25D366] mt-4 w-full" target="_blank">ğŸ’¬ Unisciti al gruppo WhatsApp</a>
            </div>
            <% if user_signed_in? %>
              <div class="flex justify-center gap-2 mt-2">
                <a href="<%= edit_stop_path(stop) %>" data-turbo-method="get" class="btn btn-primary btn-outline flex-1">ğŸ”„ Riproponi</a>
                <a href="<%= stop_path(stop) %>" data-turbo-method="delete" class="btn btn-error btn-outline flex-1">ğŸ—‘ï¸ Elimina</a>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </ul>
  <% end %>
</div>

<% if user_signed_in? %>
  <footer>
    <%= button_to "Esci", destroy_user_session_path, method: :delete, class: "text-center text-sm w-full block cursor-pointer" %>
  </footer>
<% end %>